openapi: 3.0.0
paths:
  /movements/validation:
    post:
      description: >-
        Validates a list of bank movements by comparing them with control points
        (balances). Detects inconsistencies, duplicates, and anomalies.
      operationId: MovementController_validateMovements
      parameters: []
      requestBody:
        required: true
        description: Validation data containing movements and balances
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequestDto'
            examples:
              valid:
                summary: 'Request: Valid movements'
                value:
                  movements:
                    - id: 1
                      date: '2024-01-05'
                      label: SALARY PAYMENT
                      amount: 3000
                    - id: 2
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                    - id: 3
                      date: '2024-01-15'
                      label: UTILITIES
                      amount: -150
                    - id: 4
                      date: '2024-01-20'
                      label: GROCERY STORE
                      amount: -120.5
                  balances:
                    - date: '2024-01-31'
                      balance: 1929.5
              withBalanceError:
                summary: 'Request: Balance mismatch error'
                value:
                  movements:
                    - id: 1
                      date: '2024-01-05'
                      label: SALARY PAYMENT
                      amount: 3000
                    - id: 2
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                    - id: 3
                      date: '2024-01-15'
                      label: UTILITIES
                      amount: -150
                    - id: 4
                      date: '2024-01-20'
                      label: GROCERY STORE
                      amount: -120.5
                  balances:
                    - date: '2024-01-31'
                      balance: 2000
              withDuplicates:
                summary: 'Request: Duplicate transactions'
                value:
                  movements:
                    - id: 1
                      date: '2024-01-05'
                      label: SALARY PAYMENT
                      amount: 3000
                    - id: 2
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                    - id: 3
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                    - id: 4
                      date: '2024-01-15'
                      label: UTILITIES
                      amount: -150
                  balances:
                    - date: '2024-01-31'
                      balance: 1250
              withMissingTransaction:
                summary: 'Request: Missing transaction'
                value:
                  movements:
                    - id: 1
                      date: '2024-01-05'
                      label: SALARY PAYMENT
                      amount: 3000
                    - id: 2
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                    - id: 3
                      date: '2024-01-15'
                      label: UTILITIES
                      amount: -150
                    - id: 4
                      date: '2024-01-20'
                      label: GROCERY STORE
                      amount: -120.5
                    - id: 5
                      date: '2024-02-01'
                      label: OTHER PAYMENT
                      amount: -500
                  balances:
                    - date: '2024-01-31'
                      balance: 1929.5
              withInvalidDateOrder:
                summary: 'Request: Invalid date order'
                value:
                  movements:
                    - id: 1
                      date: '2024-01-05'
                      label: SALARY PAYMENT
                      amount: 3000
                    - id: 2
                      date: '2024-01-10'
                      label: RENT PAYMENT
                      amount: -800
                  balances:
                    - date: '2024-01-31'
                      balance: 2200
                    - date: '2024-01-15'
                      balance: 2500
      responses:
        '200':
          description: Validation successful - All movements are valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationSuccessResponse'
              examples:
                valid:
                  summary: 'Response: Validation successful'
                  value:
                    message: Accepted
        '400':
          description: Validation failed - One or more errors have been detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationFailureResponse'
              examples:
                withBalanceError:
                  summary: 'Response: Balance mismatch error'
                  value:
                    message: Validation failed
                    reasons:
                      - type: BALANCE_MISMATCH
                        errors:
                          - message: >-
                              Balance mismatch at control point
                              2024-01-31T00:00:00.000Z
                            details:
                              balanceDate: '2024-01-31T00:00:00.000Z'
                              expectedBalance: 1929.5
                              actualBalance: 2000
                              difference: -70.5
                withDuplicates:
                  summary: 'Response: Duplicate transactions detected'
                  value:
                    message: Validation failed
                    reasons:
                      - type: DUPLICATE_TRANSACTION
                        errors:
                          - message: Found 2 duplicate transaction(s)
                            details:
                              duplicateMovements:
                                - id: 2
                                  date: '2024-01-10T00:00:00.000Z'
                                  label: RENT PAYMENT
                                  amount: -800
                                  duplicateType: exact
                                - id: 3
                                  date: '2024-01-10T00:00:00.000Z'
                                  label: RENT PAYMENT
                                  amount: -800
                                  duplicateType: exact
                withMissingTransaction:
                  summary: 'Response: Missing transaction detected'
                  value:
                    message: Validation failed
                    reasons:
                      - type: MISSING_TRANSACTION
                        errors:
                          - message: >-
                              There are 1 movement(s) after the last balance
                              control point. This may indicate missing balance
                              control points or missing transactions.
                            details:
                              periodStart: '2024-01-31T00:00:00.000Z'
                              periodEnd: '2024-02-01T00:00:00.000Z'
                              missingAmount: -500
                withInvalidDateOrder:
                  summary: 'Response: Invalid date order detected'
                  value:
                    message: Validation failed
                    reasons:
                      - type: INVALID_DATE_ORDER
                        errors:
                          - message: >-
                              Balance control points must be in chronological
                              order
                            details:
                              balanceDate: '2024-01-15T00:00:00.000Z'
                              balanceIndex: 1
      summary: Validate bank movements
      tags:
        - movements
  /health:
    get:
      description: Returns the application health status with its uptime.
      operationId: HealthController_check
      parameters: []
      responses:
        '200':
          description: Application is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                    description: Application health status
                  timestamp:
                    type: string
                    format: date-time
                    example: '2024-01-15T10:30:00.000Z'
                    description: Response timestamp
                  uptime:
                    type: number
                    description: Uptime in seconds
                    example: 123.456
                required:
                  - status
                  - timestamp
                  - uptime
              examples:
                healthy:
                  summary: Healthy application - The application is working correctly
                  value:
                    status: ok
                    timestamp: '2024-01-15T10:30:00.000Z'
                    uptime: 123.456
        '503':
          description: >-
            Service unavailable - The application is not available (future case
            with advanced health checks)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: Service temporarily unavailable
      summary: Check application status
      tags:
        - health
info:
  title: Dougs Bank Validation API
  description: >-
    Bank transaction validation API for Dougs, accounting firm. Allows
    validation of bank synchronization integrity by comparing transactions with
    control points (balances).
  version: '1.0'
  contact: {}
tags:
  - name: movements
    description: Bank movement validation
  - name: health
    description: Application status check
servers: []
components:
  schemas:
    MovementDto:
      type: object
      properties:
        id:
          type: number
          description: Identifiant unique du mouvement
          example: 1
        date:
          type: string
          description: Date du mouvement au format ISO (YYYY-MM-DD)
          example: '2024-01-15'
        label:
          type: string
          description: Libellé du mouvement
          example: SALARY PAYMENT
        amount:
          type: number
          description: Montant du mouvement (positif pour crédit, négatif pour débit)
          example: 3000
      required:
        - id
        - date
        - label
        - amount
    BalanceDto:
      type: object
      properties:
        date:
          type: string
          description: Date du point de contrôle au format ISO (YYYY-MM-DD)
          example: '2024-01-31'
        balance:
          type: number
          description: Solde au point de contrôle
          example: 1929.5
      required:
        - date
        - balance
    ValidationRequestDto:
      type: object
      properties:
        movements:
          description: Liste des mouvements bancaires à valider
          example:
            - id: 1
              date: '2024-01-05'
              label: SALARY PAYMENT
              amount: 3000
            - id: 2
              date: '2024-01-10'
              label: RENT PAYMENT
              amount: -800
            - id: 3
              date: '2024-01-15'
              label: UTILITIES
              amount: -150
            - id: 4
              date: '2024-01-20'
              label: GROCERY STORE
              amount: -120.5
          type: array
          items:
            $ref: '#/components/schemas/MovementDto'
        balances:
          description: Liste des points de contrôle (soldes)
          example:
            - date: '2024-01-31'
              balance: 1929.5
          type: array
          items:
            $ref: '#/components/schemas/BalanceDto'
      required:
        - movements
        - balances
    ValidationSuccessResponse:
      type: object
      properties:
        message:
          type: string
          description: Message de succès
          example: Accepted
      required:
        - message
    ValidationReasonDetailsDto:
      type: object
      properties:
        balanceDate:
          type: string
          description: Date du point de contrôle concerné
        balanceIndex:
          type: number
          description: Index du point de contrôle posant problème (0-based)
        expectedBalance:
          type: number
          description: Solde attendu
        actualBalance:
          type: number
          description: Solde réel
        difference:
          type: number
          description: Différence entre solde attendu et réel
        duplicateMovements:
          type: array
          description: Mouvements dupliqués détectés
          items:
            type: object
            properties:
              id:
                type: number
              date:
                type: string
              amount:
                type: number
              label:
                type: string
              duplicateType:
                type: string
                enum:
                  - exact
                  - similar
                description: >-
                  Type de doublon: 'exact' pour labels identiques, 'similar'
                  pour labels similaires
        missingAmount:
          type: number
          description: Montant manquant
        periodStart:
          type: string
          description: Début de la période concernée
        periodEnd:
          type: string
          description: Fin de la période concernée
    ValidationErrorDto:
      type: object
      properties:
        message:
          type: string
          description: Message descriptif de l'erreur
          example: Balance mismatch at control point 2024-01-31T00:00:00.000Z
        details:
          description: Détails spécifiques à l'erreur
          allOf:
            - $ref: '#/components/schemas/ValidationReasonDetailsDto'
      required:
        - message
        - details
    ValidationReasonDto:
      type: object
      properties:
        type:
          type: string
          enum:
            - BALANCE_MISMATCH
            - DUPLICATE_TRANSACTION
            - MISSING_TRANSACTION
            - INVALID_DATE_ORDER
          description: Type de raison de validation
          example: BALANCE_MISMATCH
        errors:
          description: Liste des erreurs de ce type
          type: array
          items:
            $ref: '#/components/schemas/ValidationErrorDto'
      required:
        - type
        - errors
    ValidationFailureResponse:
      type: object
      properties:
        message:
          type: string
          description: Message d'échec
          example: Validation failed
        reasons:
          description: Liste des raisons de l'échec de validation
          type: array
          items:
            $ref: '#/components/schemas/ValidationReasonDto'
      required:
        - message
        - reasons
