name: Generate API Documentation

# NOTE: This workflow is kept as a backup. Documentation is primarily
# generated via pre-commit hook. This ensures documentation is updated
# even if commits are made directly on GitHub or if the hook is bypassed.

on:
  push:
    branches: [main]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.dto.ts'
      - 'src/**/*.controller.ts'
      - 'src/**/*.service.ts'
      - 'src/**/*.module.ts'
      - 'package.json'
      - '.github/workflows/generate-api-docs.yml'

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit to compare
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # Use PAT for authentication

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Generate API documentation
        run: npm run generate:api-docs

      - name: Check if documentation changed
        id: check-docs
        run: |
          # Check if files exist in git (if not, they're new and should be committed)
          if ! git ls-files --error-unmatch documentation/api/openapi.json >/dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù API documentation file is new, will be committed"
            exit 0
          fi

          # Check if the generated file differs from the committed version
          if ! git diff --quiet HEAD -- documentation/api/openapi.json documentation/api/openapi.yaml documentation/api/api-documentation.html 2>/dev/null; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù API documentation has changed"
            echo "Changes:"
            git diff --stat HEAD -- documentation/api/openapi.json documentation/api/openapi.yaml documentation/api/api-documentation.html || true
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "üìù No changes detected in API documentation"
          fi

      - name: Commit and push documentation
        if: steps.check-docs.outputs.changed == 'true'
        run: |
          git config --local user.email "vincou40@gmail.com"
          git config --local user.name "GoBwah"
          git add documentation/api/openapi.json documentation/api/openapi.yaml documentation/api/api-documentation.html
          git commit -m "docs: update API documentation [skip ci]" || exit 0
          git push
        env:
          # Use PAT for push authentication
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
